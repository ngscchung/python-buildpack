#!/usr/bin/env bash


echo "=====> Inside pre_compile!!!"

# fail fast
set -e

LP_DIR=`cd $(dirname $0); cd ..; pwd`

function error() {
  echo " !     $*" >&2
  exit 1
}

function topic() {
  echo "-----> $*"
}

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

install_oracle_libraries(){
  echo $HOME
  echo $BUILD_DIR
  #local build_dir=${1:-}
  echo "Installing oracle libraries"
  #mkdir -p $build_dir/oracle
  local oracle_home=$DEPS_DIR/$DEPS_IDX/oracle
  #local oracle_home=$BUILD_DIR/.oracle
  mkdir -p $oracle_home
  #cd $build_dir/oracle
  cd $oracle_home
  local basic_download_url="http://files.cargosmart.org/python/instantclient-basic-linux.x64-11.2.0.4.0.tar.gz"
  local sdk_download_url="http://files.cargosmart.org/python/instantclient-sdk-linux.x64-11.2.0.4.0.tar.gz"
  #curl -k "$basic_download_url" --silent --fail --retry 5 --retry-max-time 15 -o instantclient-basic.zip
  wget --no-proxy "$basic_download_url"
  echo "Downloaded [$basic_download_url]"
  #curl -k "$sdk_download_url" --silent --fail --retry 5 --retry-max-time 15 -o instantclient-sdk.zip
  wget --no-proxy "$sdk_download_url"
  echo "Downloaded [$sdk_download_url]"
  echo "unzipping libraries"
  #unzip instantclient-basic.zip
  tar -xvzf instantclient-basic-linux.x64-11.2.0.4.0.tar.gz
  #unzip instantclient-sdk.zip
  tar -xvzf instantclient-sdk-linux.x64-11.2.0.4.0.tar.gz
  rm instantclient-basic-linux.x64-11.2.0.4.0.tar.gz
  rm instantclient-sdk-linux.x64-11.2.0.4.0.tar.gz
  mv instantclient_11_2 instantclient
  cd instantclient
  ln -s libclntsh.so.11.1 libclntsh.so
  ln -s libocci.so.11.1 libocci.so
  
  # prepare env variables for pip install use
  # append_profile_d ORACLE_HOME "\$DEPS_DIR/$DEPS_IDX/oracle/instantclient"
  echo $DEPS_DIR/$DEPS_IDX/oracle/instantclient > $DEPS_DIR/$DEPS_IDX/env/ORACLE_HOME
  # append_profile_d LD_RUN_PATH "\$DEPS_DIR/$DEPS_IDX/oracle/instantclient"
  echo $DEPS_DIR/$DEPS_IDX/oracle/instantclient > $DEPS_DIR/$DEPS_IDX/env/LD_RUN_PATH
  
  # prepare env variables for python runtime use
cat <<EOF >$BUILD_DIR/.profile.d/001_oracleclient.sh
export LD_LIBRARY_PATH="\$DEPS_DIR/$DEPS_IDX/oracle/instantclient:\$LD_LIBRARY_PATH"
export LD_RUN_PATH="\$DEPS_DIR/$DEPS_IDX/oracle/instantclient:\$LD_RUN_PATH"
export ORACLE_HOME="\$DEPS_DIR/$DEPS_IDX/oracle/instantclient:\$ORACLE_HOME"
export PATH="\$DEPS_DIR/$DEPS_IDX/oracle/instantclient:\$PATH"
EOF
   
}

install_oracle_libraries 
